<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìê¸°ì£¼ë„ í•™ìŠµ ìº˜ë¦°ë”</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ê³„íšë³„ ìƒ‰ìƒ */
    .plan-color-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
      vertical-align: middle;
    }
    
    /* ìƒ‰ìƒ í…Œë§ˆ ë³€ìˆ˜ - ê¸°ë³¸: ê·¸ë¦° */
    :root {
      --color-today: #14b8a6;
      --color-done: #10b981;
      --color-partial: #84cc16;
      --color-planned: #86efac;
      --color-missed: #15803d;
    }

    /* ë¸”ë£¨ í…Œë§ˆ */
    body.theme-blue {
      --color-today: #2563eb;
      --color-done: #3b82f6;
      --color-partial: #60a5fa;
      --color-planned: #93c5fd;
      --color-missed: #1e40af;
    }

    /* ì½”ëŸ´ í…Œë§ˆ */
    body.theme-coral {
      --color-today: #C93A34;
      --color-done: #F05C55;
      --color-partial: #FF8F8A;
      --color-planned: #FFB8B4;
      --color-missed: #FFE3E1;
    }

    /* ìƒ‰ìƒ í´ë˜ìŠ¤ ì ìš© */
    .color-today { background-color: var(--color-today); }
    .color-done { background-color: var(--color-done); }
    .color-partial { background-color: var(--color-partial); }
    .color-planned { background-color: var(--color-planned); }
    .color-missed { background-color: var(--color-missed); }

    .status-today { background-color: var(--color-today) !important; }
    .status-done { background-color: var(--color-done) !important; }
    .status-partial { background-color: var(--color-partial) !important; }
    .status-planned { background-color: var(--color-planned) !important; }
    .status-missed { background-color: var(--color-missed) !important; }    .status-today { background-color: #3b82f6; color: white; }
    .status-done { background-color: #10b981; color: white; }
    .status-partial { background-color: #fbbf24; color: white; }
    .status-planned { background-color: #9ca3af; color: white; }
    .status-missed { background-color: #ef4444; color: white; }
    .status-none { background-color: transparent; }
  </style>
</head>
<body class="bg-blue-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">ìê¸°ì£¼ë„ í•™ìŠµ ìº˜ë¦°ë”</h1>
        <p class="text-gray-600">{{ year }}ë…„ {{ summary.total }}ì¼ì˜ í•™ìŠµ ì—¬ì •ì„ ì‹œì‘í•˜ì„¸ìš”</p>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-sm text-gray-600">ğŸ‘¤ <strong>{{ session.user_name }}</strong>ë‹˜</span>
        <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
          ë¡œê·¸ì•„ì›ƒ
        </a>
      </div>
    </div>

    <!-- ë…„ë„ ì„ íƒ -->
    <div class="flex justify-center mb-4">
      <div class="bg-white px-6 py-3 rounded-xl shadow-md">
        <label class="text-sm font-medium text-gray-700 mr-3">í•™ìŠµ ë…„ë„:</label>
        <select id="yearSelector" class="border border-gray-300 rounded-lg px-4 py-2 text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
          {% for y in available_years %}
          <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}ë…„</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-8">
      <div class="mb-3">
        <span class="text-sm font-semibold text-gray-700">ê³„íšë³„ ìƒ‰ìƒ</span>
      </div>
      <div class="flex justify-center items-center gap-6 flex-wrap">
        {% for p in plans %}
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded-full" style="background-color: {{ p.color }};"></div>
          <span class="text-sm">{{ p.title }}</span>
        </div>
        {% endfor %}
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded-full border-2 border-gray-300"></div>
          <span class="text-sm">ê³„íš ì—†ìŒ</span>
        </div>
      </div>
    </div>

    <!-- í•™ìŠµ ê³„íš ì„ íƒ -->
    <div class="bg-white p-4 rounded-2xl shadow mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">í•™ìŠµ ê³„íš ì„ íƒ</h2>
        <div class="flex gap-3">
          <button id="openManagePlanModal" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">ê³„íšìˆ˜ì •</button>
          <button id="openPlanModal" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">+ ìƒˆ ê³„íš</button>
          <button id="openCreateTemplateModal" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">ìƒˆ í…œí”Œë¦¿</button>
          <button id="openTemplateManageModal" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">í…œí”Œë¦¿ ìˆ˜ì •</button>
        </div>
      </div>

      <div class="flex items-center gap-3 mb-4">
        <label for="planFilterSelect" class="text-sm font-semibold text-gray-700">ìº˜ë¦°ë” í‘œì‹œ:</label>
        <select id="planFilterSelect" class="border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 w-60">
          <option value="">ëª¨ë“  ê³„íš</option>
          {% for p in plans %}
            <option value="{{ p.plan_id }}" style="background: linear-gradient(90deg, {{ p.color }} 12px, white 12px);">
              â— {{ p.title }} ({{ p.subject }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="flex gap-4 flex-wrap">
        {% for p in plans %}
          <div class="border p-4 rounded-xl w-72 hover:shadow-md plan-card" data-plan-id="{{ p.plan_id }}" style="border-left: 4px solid {{ p.color }}; background: linear-gradient(135deg, {{ p.color }}10 0%, white 100%);">
            <div class="font-semibold mb-1">
              <span class="plan-color-indicator" style="background-color: {{ p.color }};"></span>{{ p.title }}
            </div>
            <div class="text-sm text-gray-500">ê³¼ëª©: {{ p.subject }}</div>
            <div class="text-xs text-gray-400">ì¼ì¼ ê³„íš: {{ p.days|length }}ê°œ</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ë‹¬ë ¥ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      {% for m in range(1, 13) %}
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-center font-semibold mb-3 text-lg">{{ m }}ì›”</h2>
        <div class="grid grid-cols-7 text-center text-sm font-medium mb-2">
          <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
        </div>
        <div class="grid grid-cols-7 gap-1">
          {% for d in calendar_data.get(m, []) %}
            {% if d %}
              {% set color_style = "" %}
              {% if d.color %}
                {% if d.status == 'done' %}
                  {% set color_style = "background-color: " + d.color + "; filter: brightness(0.85) saturate(1.4); color: #fff; font-weight: 600;" %}
                {% elif d.status == 'partial' %}
                  {% set color_style = "background-color: " + d.color + "; filter: brightness(0.9) saturate(1.1); color: #333; font-weight: 500;" %}
                {% else %}
                  {% set color_style = "background-color: " + d.color + "; color: #333; font-weight: 500;" %}
                {% endif %}
              {% endif %}
              <div class="aspect-square flex items-center justify-center rounded-lg border text-sm cursor-pointer
                  {% if d.color %}status-plan-color{% else %}status-none{% endif %}"
                  data-day-id="{{ d.day_id }}"
                  data-plan-id="{{ d.plan_id }}"
                  data-status="{{ d.status }}"
                  {% if color_style %}style="{{ color_style }}"{% endif %}>
                {{ d.date.day }}
              </div>
            {% else %}
              <div class="aspect-square"></div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ìƒˆ ê³„íš / ë¶ˆëŸ¬ì˜¤ê¸° ì„ íƒ ëª¨ë‹¬ -->
  <div id="planChoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[360px] shadow-lg relative text-center">
      <button id="closePlanChoiceModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800">âœ•</button>
      <h2 class="text-lg font-bold mb-5">í•™ìŠµ ê³„íš ì¶”ê°€</h2>
      <div class="flex flex-col gap-3">
        <button id="openNewPlan" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">ìƒˆ ê³„íš ë§Œë“¤ê¸°</button>
        <button id="openLoadPlan" class="bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded">ê¸°ì¡´ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

  <!-- í•™ìŠµ ê³„íš ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="planModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[460px] shadow-lg relative">
      <button id="closePlanModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800">âœ•</button>
      <h2 class="text-lg font-bold mb-4 text-center">ìƒˆ í•™ìŠµ ê³„íš ì¶”ê°€</h2>

      <label class="block text-sm font-medium mb-1">ê³„íš ì œëª©</label>
      <input id="planTitle" type="text" class="w-full border rounded px-2 py-1 mb-3" placeholder="ì˜ˆ: TOEFL ë‹¨ì–´ ì™¸ìš°ê¸°">

      <label class="block text-sm font-medium mb-1">ê³¼ëª©ëª…</label>
      <input id="planSubject" type="text" class="w-full border rounded px-2 py-1 mb-3" placeholder="ì˜ˆ: ì˜ì–´">

      <div class="flex gap-4 mb-3">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
          <input id="planStart" type="date" class="w-full border rounded px-2 py-1">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
          <input id="planEnd" type="date" class="w-full border rounded px-2 py-1">
        </div>
      </div>

      <div class="flex justify-end">
        <button id="savePlanBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ -->
  <div id="loadTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[560px] shadow-lg relative">
      <button id="closeLoadTemplateModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800">âœ•</button>
      <h2 class="text-lg font-bold mb-4 text-center">í…œí”Œë¦¿ì—ì„œ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°</h2>

      <label class="block text-sm font-medium mb-1">ì‚¬ìš©í•  í…œí”Œë¦¿ ì„ íƒ</label>
      <select id="loadTemplatePlanSelect" class="w-full border rounded px-2 py-1 mb-3">
        <option value="">-- í…œí”Œë¦¿ ì„ íƒ --</option>
      </select>

      <label class="block text-sm font-medium mb-1">ìƒˆ ê³„íš ì œëª©</label>
      <input id="loadTemplateTitle" type="text" class="w-full border rounded px-2 py-1 mb-3" placeholder="ì˜ˆ: 2025ë…„ 1ì›” TOEFL">

      <label class="block text-sm font-medium mb-1">ê³¼ëª©ëª…</label>
      <input id="loadTemplateSubject" type="text" class="w-full border rounded px-2 py-1 mb-3" placeholder="ì˜ˆ: ì˜ì–´">

      <div class="mb-3">
        <span class="block text-sm font-medium mb-2">ìš”ì¼ ì„ íƒ</span>
        <div class="flex gap-3 text-sm">
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="mon" checked>ì›”</label>
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="tue" checked>í™”</label>
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="wed" checked>ìˆ˜</label>
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="thu" checked>ëª©</label>
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="fri" checked>ê¸ˆ</label>
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="sat" checked>í† </label>
          <label class="flex items-center gap-1"><input type="checkbox" class="weekday-checkbox" value="sun" checked>ì¼</label>
        </div>
        <p class="text-xs text-gray-500 mt-1">ì„ íƒí•œ ìš”ì¼ì—ë§Œ í…œí”Œë¦¿ ìˆœì„œëŒ€ë¡œ ì¼ì •ì´ ë°°ì¹˜ë©ë‹ˆë‹¤.</p>
      </div>

      <div class="flex gap-4 mb-3">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
          <input id="loadTemplateStart" type="date" class="w-full border rounded px-2 py-1">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
          <input id="loadTemplateEnd" type="date" class="w-full border rounded px-2 py-1">
        </div>
      </div>

      <div class="text-xs text-gray-500 mb-4">ì„ íƒí•œ ê³„íšì˜ í…œí”Œë¦¿ì„ ë‚ ì§œ ë²”ìœ„ë¡œ ë‚˜ëˆ„ì–´ ì¼ì¼ ê³„íšì„ ìƒì„±í•©ë‹ˆë‹¤.</div>

      <div class="flex justify-end gap-2">
        <button id="cancelLoadTemplate" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">ì·¨ì†Œ</button>
        <button id="confirmLoadTemplate" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">ìƒì„±</button>
      </div>
    </div>
  </div>

  <!-- í•™ìŠµ ê³„íš ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="managePlanModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto shadow-lg relative">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
        <h2 class="text-2xl font-bold">í•™ìŠµ ê³„íš ê´€ë¦¬</h2>
        <button id="closeManagePlanModal" class="text-gray-500 hover:text-gray-800 text-2xl">âœ•</button>
      </div>
      
      <div class="p-6">
        <p class="text-gray-600 mb-6">ì›í•˜ì‹  ìƒˆë¡œ ê³„íšì„ ìƒì„±í•œ í›„ ì œ ê³„íšì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-4 gap-4 mb-8" id="statsContainer">
          <div class="bg-white rounded-xl shadow p-6 text-center border">
            <div class="text-3xl font-bold text-blue-600 mb-2">{{ stats.total_plans }}</div>
            <div class="text-sm text-gray-600">ì „ì²´ ê³„íš</div>
          </div>
          <div class="bg-white rounded-xl shadow p-6 text-center border">
            <div class="text-3xl font-bold text-green-600 mb-2">{{ stats.total_assigned }}</div>
            <div class="text-sm text-gray-600">ì´ í• ë‹¹ ê³„íš</div>
          </div>
          <div class="bg-white rounded-xl shadow p-6 text-center border">
            <div class="text-3xl font-bold text-purple-600 mb-2">{{ stats.completed }}</div>
            <div class="text-sm text-gray-600">ì™„ë£Œëœ ê³„íš</div>
          </div>
          <div class="bg-white rounded-xl shadow p-6 text-center border">
            <div class="text-3xl font-bold text-orange-600 mb-2">{{ stats.completion_rate }}%</div>
            <div class="text-sm text-gray-600">ì™„ë£Œìœ¨</div>
          </div>
        </div>

        <!-- ê³„íš ëª©ë¡ -->
        <div class="space-y-4" id="plansContainer">
          {% for plan in plans %}
          <div class="bg-white rounded-xl shadow p-6 {{ 'border-blue-500 ring-2 ring-blue-200' if active_plan and plan.plan_id == active_plan.plan_id else 'hover:border-blue-400' }}" style="border-left: 4px solid {{ plan.color }}; background: linear-gradient(135deg, {{ plan.color }}10 0%, white 100%);" data-plan-id="{{ plan.plan_id }}">
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="plan-color-indicator" style="background-color: {{ plan.color }};"></span>
                  <h3 class="text-xl font-bold">{{ plan.title }}</h3>
                  <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">ë³¸ë¬¸</span>
                </div>
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                  <div>
                    <span class="mr-1">ğŸ“š ê³¼ëª©:</span>
                    <span class="font-medium">{{ plan.subject }}</span>
                  </div>
                  <div>
                    <span class="mr-1">ğŸ“… ìƒì„±ì¼:</span>
                    <span>{{ plan.start_date }}</span>
                  </div>
                  <div>
                    <span class="mr-1">ğŸ“ˆ ì§„ë„:</span>
                    <span>18/38</span>
                  </div>
                </div>
              </div>
              <div class="flex items-start gap-2 flex-shrink-0">
                <button type="button" class="toggle-daily-plan-modal bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">
                  â–¼ ìƒì„¸ê³„íš ({{ plan.daily_plans|length }})
                </button>
                <button type="button" class="edit-plan-btn-modal text-blue-600 hover:text-blue-800 text-xl" data-plan-id="{{ plan.plan_id }}" title="ìˆ˜ì •">âœï¸</button>
                <button type="button" class="delete-plan-btn-modal text-red-600 hover:text-red-800 text-xl" data-plan-id="{{ plan.plan_id }}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
              </div>
            </div>

            <!-- ì¼ì¼ ê³„íš í¸ì§‘ ì„¹ì…˜ -->
            <div class="daily-plan-section-modal hidden mt-6 border-t pt-6" data-plan-id="{{ plan.plan_id }}">
              <h4 class="font-semibold mb-4">ì¼ì¼ ê³„íš í¸ì§‘</h4>
              
              <div class="flex gap-2 mb-4">
                <button class="add-row-btn-modal bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">+ í–‰ ì¶”ê°€</button>
                <button class="save-daily-plan-btn-modal bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">ì €ì¥</button>
                <button class="cancel-edit-btn-modal bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">ì·¨ì†Œ</button>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full text-sm" id="daily-plan-table-modal-{{ plan.plan_id }}">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-2 text-left">í•™ìŠµ ë‚ ì§œ</th>
                      <th class="px-4 py-2 text-left">ìˆœì„œ</th>
                      <th class="px-4 py-2 text-left">í•™ìŠµ ë‚´ìš© ì„¤ëª…</th>
                      <th class="px-4 py-2 text-left">ë§í¬</th>
                      <th class="px-4 py-2 text-left">ìƒíƒœ</th>
                      <th class="px-4 py-2 text-center">ì‚­ì œ</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- ê³„íš í¸ì§‘ ëª¨ë‹¬ -->
  <div id="editPlanModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-2xl shadow-lg relative">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
        <h2 class="text-2xl font-bold">ê³„íš í¸ì§‘</h2>
        <button id="closeEditPlanModal" class="text-gray-500 hover:text-gray-800 text-2xl">âœ•</button>
      </div>

      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">ê³„íš ì œëª©</label>
          <input id="editPlanTitle" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">ê³¼ëª©ëª…</label>
          <input id="editPlanSubject" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium mb-3">ìƒ‰ìƒ ì„ íƒ</label>
          <div class="grid grid-cols-7 gap-3" id="colorPicker">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>
        </div>

        <div class="flex gap-3 justify-end pt-4 border-t">
          <button id="cancelEditPlan" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium">ì·¨ì†Œ</button>
          <button id="saveEditPlan" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬ (iframeìœ¼ë¡œ ê¸°ì¡´ í˜ì´ì§€ ë¡œë“œ) -->
  <div id="templateManageModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-6xl h-[85vh] shadow-lg relative overflow-hidden">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
        <h2 class="text-2xl font-bold">í…œí”Œë¦¿ ê´€ë¦¬</h2>
        <button id="closeTemplateManageModal" class="text-gray-500 hover:text-gray-800 text-2xl">âœ•</button>
      </div>
      <iframe id="templateManageFrame" class="w-full h-[calc(85vh-64px)]" src="" title="í…œí”Œë¦¿ ê´€ë¦¬"></iframe>
    </div>
  </div>

  <!-- í•™ìŠµ ì‹¤ì  ëª¨ë‹¬ -->
  <div id="dayModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[500px] shadow-lg relative">
      <button id="closeModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800">âœ•</button>
      <h2 id="modalDate" class="text-lg font-bold mb-4">ë‚ ì§œ</h2>
      
      <!-- ì‘ì—… ë¦¬ìŠ¤íŠ¸ -->
      <div id="taskList" class="space-y-3 mb-4">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
      
      <div class="flex justify-end">
        <button id="closeModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìƒˆ í…œí”Œë¦¿ ë§Œë“¤ê¸° ëª¨ë‹¬ -->
  <div id="createTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[800px] max-h-[90vh] overflow-y-auto shadow-lg relative">
      <button id="closeCreateTemplateModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <h2 class="text-xl font-bold mb-4">ìƒˆ í…œí”Œë¦¿ ë§Œë“¤ê¸°</h2>
      
      <!-- í…œí”Œë¦¿ ê¸°ë³¸ ì •ë³´ -->
      <div class="mb-6 space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">í…œí”Œë¦¿ ì œëª© *</label>
          <input type="text" id="newTemplateTitle" placeholder="ì˜ˆ: TOEFL ì˜ë‹¨ì–´ ê³µë¶€"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ê³¼ëª©</label>
          <input type="text" id="newTemplateSubject" placeholder="ì˜ˆ: ì˜ì–´"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ì„¤ëª…</label>
          <textarea id="newTemplateDescription" rows="2" placeholder="í…œí”Œë¦¿ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
      </div>

      <!-- ë¹ ë¥¸ ì…ë ¥: íŒŒì¼ ì—…ë¡œë“œ / ë¶™ì—¬ë„£ê¸° -->
      <div class="mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- CSV íŒŒì¼ ì—…ë¡œë“œ -->
          <div class="border rounded-lg p-4">
            <div class="font-semibold mb-3">íŒŒì¼ ì—…ë¡œë“œ (.csv)</div>
            <input id="createTemplateFile" type="file" accept=".csv" class="mb-3 w-full" />
            <button id="createTemplateImportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">í•­ëª©ì— ì¶”ê°€</button>
            <p class="text-xs text-gray-500 mt-2">CSV í—¤ë” ì˜ˆ: title,link_url</p>
          </div>
          <!-- í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° -->
          <div class="border rounded-lg p-4">
            <div class="font-semibold mb-3">ë¶™ì—¬ë„£ê¸° (í–‰ë‹¹ ì œëª©,ë§í¬ ë˜ëŠ” íƒ­)</div>
            <textarea id="createTemplatePaste" rows="4" class="w-full border rounded px-2 py-1 mb-3" placeholder="ì˜ˆ) ë‹¨ì–´ì•”ê¸°&#10;https://example..."></textarea>
            <button id="createTemplatePasteBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">í•­ëª©ì— ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <!-- í…œí”Œë¦¿ í•­ëª© ëª©ë¡ -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <label class="text-sm font-medium text-gray-700">í…œí”Œë¦¿ í•­ëª© (<span id="templateItemCount">0</span>ê°œ)</label>
          <button id="addTemplateItemBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
            + í•­ëª© ì¶”ê°€
          </button>
        </div>
        <div id="templateItemsList" class="space-y-3 max-h-[300px] overflow-y-auto">
          <!-- í…œí”Œë¦¿ í•­ëª©ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        <div class="mt-3 flex justify-end">
          <button id="clearTemplateItemsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded text-sm">í•­ëª© ëª¨ë‘ ë¹„ìš°ê¸°</button>
        </div>
      </div>

      <!-- ì €ì¥ ë²„íŠ¼ -->
      <div class="flex justify-end gap-3 mt-6">
        <button id="cancelCreateTemplateBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg">ì·¨ì†Œ</button>
        <button id="saveCreateTemplateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[720px] shadow-lg relative">
      <button id="closeTemplateModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800">âœ•</button>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">í…œí”Œë¦¿ ê´€ë¦¬</h2>
      </div>
      <p class="text-sm text-gray-600 mb-1">CSV/Excel ì—…ë¡œë“œ ë˜ëŠ” ë¶™ì—¬ë„£ê¸°ë¡œ í…œí”Œë¦¿ ì‘ì—…ì„ ì¶”ê°€í•˜ì„¸ìš”. ì—…ë¡œë“œ/ë¶™ì—¬ë„£ê¸°ì—ì„œëŠ” ë©”ëª¨ë¥¼ ì œì™¸í•˜ê³  ì œëª©ê³¼ ë§í¬ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
      <div id="templateStatus" class="text-xs text-gray-500 mb-3"></div>

      <div class="grid grid-cols-1 gap-6">
        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="border rounded-lg p-4">
          <div class="font-semibold mb-2">íŒŒì¼ ì—…ë¡œë“œ (.csv, .xlsx)</div>
          <input id="templateFile" type="file" accept=".csv,.xlsx" class="mb-3" />
          <button id="uploadTemplateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">ì—…ë¡œë“œ</button>
          <p class="text-xs text-gray-500 mt-2">CSV í—¤ë” ì˜ˆ: title,link_url</p>
        </div>

        <!-- ë¶™ì—¬ë„£ê¸° -->
        <div class="border rounded-lg p-4">
          <div class="font-semibold mb-2">ë¶™ì—¬ë„£ê¸° (í–‰ë‹¹ "ì œëª©,ë§í¬" ë˜ëŠ” íƒ­ êµ¬ë¶„)</div>
          <textarea id="templatePaste" rows="8" class="w-full border rounded px-2 py-1" placeholder="ì˜ˆ) 01. ABC  https://...\..."></textarea>
          <button id="savePasteBtn" class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">ë¶™ì—¬ë„£ê¸° ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
  // ê³„íš ë°ì´í„°ë¥¼ JavaScriptì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„
  const plansDataMap = {
    {% for p in plans %}
    "{{ p.plan_id }}": {
      "title": "{{ p.title }}",
      "subject": "{{ p.subject }}",
      "color": "{{ p.color }}"
    }{{ "," if not loop.last }}
    {% endfor %}
  };
  
  // localStorageì—ì„œ ì €ì¥ëœ ê³„íš ìƒ‰ìƒ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadPlanColorsFromStorage() {
    try {
      const savedColors = JSON.parse(localStorage.getItem('planColors') || '{}');
      Object.keys(savedColors).forEach(planId => {
        if (plansDataMap[planId]) {
          plansDataMap[planId].color = savedColors[planId];
        }
      });
    } catch (e) {
      console.log('ìƒ‰ìƒ ë¡œë“œ ì˜¤ë¥˜:', e);
    }
  }
  
  // ê³„íš ìƒ‰ìƒ ì €ì¥
  function savePlanColorToStorage(planId, color) {
    try {
      const savedColors = JSON.parse(localStorage.getItem('planColors') || '{}');
      savedColors[planId] = color;
      localStorage.setItem('planColors', JSON.stringify(savedColors));
      if (plansDataMap[planId]) {
        plansDataMap[planId].color = color;
      }
    } catch (e) {
      console.log('ìƒ‰ìƒ ì €ì¥ ì˜¤ë¥˜:', e);
    }
  }
  
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ìƒ‰ìƒ ë¶ˆëŸ¬ì˜¤ê¸°
  loadPlanColorsFromStorage();
  
  // ê³„íš ì¹´ë“œì™€ ë“œë¡­ë‹¤ìš´ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updatePlanColors() {
    Object.keys(plansDataMap).forEach(planId => {
      const color = plansDataMap[planId].color;
      
      // í•™ìŠµ ê³„íš ì„ íƒ ì„¹ì…˜ì˜ ê³„íš ì¹´ë“œ ì—…ë°ì´íŠ¸
      const planCard = document.querySelector(`.plan-card[data-plan-id="${planId}"]`);
      if (planCard) {
        planCard.style.borderLeftColor = color;
        planCard.style.background = `linear-gradient(135deg, ${color}10 0%, white 100%)`;
        
        // ì¹´ë“œ ë‚´ ìƒ‰ìƒ í‘œì‹œ ì—…ë°ì´íŠ¸
        const indicator = planCard.querySelector('.plan-color-indicator');
        if (indicator) {
          indicator.style.backgroundColor = color;
        }
      }
      
      // ê´€ë¦¬ ëª¨ë‹¬ì˜ ê³„íš ì¹´ë“œ ì—…ë°ì´íŠ¸
      const modalCard = document.querySelector(`#managePlanModal [data-plan-id="${planId}"]`);
      if (modalCard) {
        modalCard.style.borderLeftColor = color;
        modalCard.style.background = `linear-gradient(135deg, ${color}10 0%, white 100%)`;
        
        const indicator = modalCard.querySelector('.plan-color-indicator');
        if (indicator) {
          indicator.style.backgroundColor = color;
        }
      }
      
      // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const option = document.querySelector(`#planFilterSelect option[value="${planId}"]`);
      if (option) {
        option.style.background = `linear-gradient(90deg, ${color} 12px, white 12px)`;
      }
      
      // ë‹¬ë ¥ ì…€ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      const calendarCells = document.querySelectorAll(`[data-plan-id="${planId}"].status-plan-color`);
      calendarCells.forEach(cell => {
        const status = cell.dataset.status;
        
        cell.style.backgroundColor = color;
        
        if (status === 'done') {
          cell.style.filter = 'brightness(0.85) saturate(1.4)';
          cell.style.color = '#fff';
          cell.style.fontWeight = '600';
        } else if (status === 'partial') {
          cell.style.filter = 'brightness(0.9) saturate(1.1)';
          cell.style.color = '#333';
          cell.style.fontWeight = '500';
        } else {
          cell.style.filter = '';
          cell.style.color = '#333';
          cell.style.fontWeight = '500';
        }
      });
    });
  }
  
  // ì´ˆê¸° ìƒ‰ìƒ ì—…ë°ì´íŠ¸
  updatePlanColors();
  </script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ============ í•™ìŠµ ì‹¤ì  ëª¨ë‹¬ =============
    const modal = document.getElementById("dayModal");
    const closeBtn = document.getElementById("closeModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const modalDate = document.getElementById("modalDate");
    const taskList = document.getElementById("taskList");
    
    // ìƒˆ í…œí”Œë¦¿ ë§Œë“¤ê¸° ëª¨ë‹¬ ìš”ì†Œ
    const createTemplateModal = document.getElementById("createTemplateModal");
    const openCreateTemplateModal = document.getElementById("openCreateTemplateModal");
    const closeCreateTemplateModal = document.getElementById("closeCreateTemplateModal");
    const cancelCreateTemplateBtn = document.getElementById("cancelCreateTemplateBtn");
    const saveCreateTemplateBtn = document.getElementById("saveCreateTemplateBtn");
    const newTemplateTitle = document.getElementById("newTemplateTitle");
    const newTemplateSubject = document.getElementById("newTemplateSubject");
    const newTemplateDescription = document.getElementById("newTemplateDescription");
    const templateItemsList = document.getElementById("templateItemsList");
    const addTemplateItemBtn = document.getElementById("addTemplateItemBtn");
    const templateItemCount = document.getElementById("templateItemCount");
    const createTemplateFile = document.getElementById("createTemplateFile");
    const createTemplateImportBtn = document.getElementById("createTemplateImportBtn");
    const createTemplatePaste = document.getElementById("createTemplatePaste");
    const createTemplatePasteBtn = document.getElementById("createTemplatePasteBtn");
    const clearTemplateItemsBtn = document.getElementById("clearTemplateItemsBtn");
    
    // í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬ ìš”ì†Œ
    const templateModal = document.getElementById("templateModal");
    const closeTemplateModal = document.getElementById("closeTemplateModal");
    const templateFile = document.getElementById("templateFile");
    const uploadTemplateBtn = document.getElementById("uploadTemplateBtn");
    const templatePaste = document.getElementById("templatePaste");
    const savePasteBtn = document.getElementById("savePasteBtn");
    const templateStatus = document.getElementById("templateStatus");

    const currentYear = {{ year }};
    const urlPlanId = new URLSearchParams(window.location.search).get('plan_id');
    const activePlanId = urlPlanId ? Number(urlPlanId) : null;
    
    // ============ ìº˜ë¦°ë” í‘œì‹œ ê³„íš ì„ íƒ (ë“œë¡­ë‹¤ìš´) =============
    const planFilterSelect = document.getElementById('planFilterSelect');
    if (planFilterSelect) {
      planFilterSelect.value = activePlanId ? String(activePlanId) : '';
      planFilterSelect.addEventListener('change', () => {
        const val = planFilterSelect.value;
        const base = `/${currentYear}`;
        window.location.href = val ? `${base}?plan_id=${val}` : base;
      });
    }
    
    document.querySelectorAll("[data-day-id]").forEach(day => {
      day.addEventListener("click", async () => {
        const dayId = day.dataset.dayId;
        if (!dayId) return;
        const params = new URLSearchParams(window.location.search);
        const currentPlanId = params.get('plan_id') || (activePlanId ? String(activePlanId) : null);
        const url = currentPlanId ? `/day/${dayId}?year=${currentYear}&plan_id=${currentPlanId}` : `/day/${dayId}?year=${currentYear}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) {
          alert(data.error || "day not found");
          return;
        }
        
        modalDate.textContent = `${data.date} í•™ìŠµ ì²´í¬`;
        
        // ì‘ì—… ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        taskList.innerHTML = "";
        
        if (data.tasks && data.tasks.length > 0) {
          data.tasks.forEach(task => {
            const taskItem = document.createElement("div");
            taskItem.className = "border rounded-lg p-3 bg-gray-50";
            let taskHtml = `
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="font-semibold text-sm text-gray-800">${task.plan_title}</div>
                  <div class="text-xs text-gray-500 mb-1">${task.subject}</div>
                  <div class="text-sm text-gray-700">${task.task_title}</div>`;
            
            // ë§í¬ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (task.link_url) {
              const normalizedLink = /^(https?:\/\/)/i.test(task.link_url) ? task.link_url : `https://${task.link_url}`;
              taskHtml += `<div class="text-xs text-blue-600 mt-1"><a href="javascript:void(0)" onclick="window.open('${normalizedLink}', '_blank', 'noopener')" class="hover:underline">ğŸ”— ${task.link_url}</a></div>`;
            }
            
            taskHtml += `
                </div>
                <label class="inline-flex items-center ml-3">
                  <input type="checkbox" 
                         class="task-checkbox w-5 h-5" 
                         data-task-id="${task.task_id}"
                         ${task.status === 'done' ? 'checked' : ''}>
                </label>
              </div>
            `;
            taskItem.innerHTML = taskHtml;
            taskList.appendChild(taskItem);
          });
          
          // ê° ì²´í¬ë°•ìŠ¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          taskList.querySelectorAll(".task-checkbox").forEach(checkbox => {
            checkbox.addEventListener("change", async (e) => {
              const taskId = e.target.dataset.taskId;
              const isCompleted = e.target.checked;
              
              const res = await fetch("/day/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  task_id: taskId,
                  completed: isCompleted
                })
              });
              
              const result = await res.json();
              if (!result.ok) {
                alert(result.error || "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                e.target.checked = !isCompleted; // ë˜ëŒë¦¬ê¸°
              }
              // ì²´í¬ ì‹œ ì¦‰ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•ŠìŒ
            });
          });
        } else {
          taskList.innerHTML = '<div class="text-gray-500 text-center py-4">ì´ ë‚ ì§œì— ê³„íšëœ í•™ìŠµì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        
        modal.classList.remove("hidden");
      });
    });
    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      location.reload(); // ëª¨ë‹¬ ë‹«ì„ ë•Œ ìº˜ë¦°ë” ì—…ë°ì´íŠ¸
    });
    closeModalBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      location.reload(); // ëª¨ë‹¬ ë‹«ì„ ë•Œ ìº˜ë¦°ë” ì—…ë°ì´íŠ¸
    });

    // ê³„íš ì¹´ë“œ ë‚´ ë²„íŠ¼ í´ë¦­ ì‹œ ì¹´ë“œ ë§í¬ ë°©ì§€
    document.querySelectorAll('.toggle-daily-plan-modal, .add-row-btn-modal, .save-daily-plan-btn-modal, .cancel-edit-btn-modal').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    // (Legacy template modal handlers removed to avoid conflicts)

    // ============ ìƒˆ í…œí”Œë¦¿ ë§Œë“¤ê¸° ëª¨ë‹¬ =============
    let templateItemCounter = 0;
    
    // ëª¨ë‹¬ ì—´ê¸°
    if (openCreateTemplateModal) {
      openCreateTemplateModal.addEventListener("click", () => {
        createTemplateModal.classList.remove("hidden");
        // ì´ˆê¸°í™”
        newTemplateTitle.value = "";
        newTemplateSubject.value = "";
        newTemplateDescription.value = "";
        templateItemsList.innerHTML = "";
        templateItemCounter = 0;
        updateTemplateItemCount();
        // ì²« í•­ëª© ìë™ ì¶”ê°€
        addTemplateItem();
      });
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    if (closeCreateTemplateModal) {
      closeCreateTemplateModal.addEventListener("click", () => {
        createTemplateModal.classList.add("hidden");
      });
    }
    
    if (cancelCreateTemplateBtn) {
      cancelCreateTemplateBtn.addEventListener("click", () => {
        createTemplateModal.classList.add("hidden");
      });
    }
    
    // í•­ëª© ì¶”ê°€ ë²„íŠ¼
    if (addTemplateItemBtn) {
      addTemplateItemBtn.addEventListener("click", () => {
        addTemplateItem();
      });
    }
    
    // í…œí”Œë¦¿ í•­ëª© ì¶”ê°€ í•¨ìˆ˜
    function addTemplateItem(title = "", linkUrl = "") {
      templateItemCounter++;
      const itemId = `templateItem_${templateItemCounter}`;
      
      const itemDiv = document.createElement("div");
      itemDiv.id = itemId;
      itemDiv.className = "border rounded-lg p-3 bg-gray-50";
      itemDiv.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-8 text-center text-gray-500 font-medium pt-2">${templateItemCounter}</div>
          <div class="flex-1 space-y-2">
            <input type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                   class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                   data-field="title" value="${title}">
            <input type="text" placeholder="ë§í¬ URL (ì„ íƒì‚¬í•­)" 
                   class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                   data-field="link" value="${linkUrl}">
          </div>
          <button class="flex-shrink-0 text-red-500 hover:text-red-700 text-xl" onclick="removeTemplateItem('${itemId}')">
            &times;
          </button>
        </div>
      `;
      
      templateItemsList.appendChild(itemDiv);
      updateTemplateItemCount();
    }
    
    // í•­ëª© ì œê±° í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ)
    window.removeTemplateItem = function(itemId) {
      const item = document.getElementById(itemId);
      if (item) {
        item.remove();
        updateTemplateItemCount();
        // ìˆœë²ˆ ì¬ì •ë ¬
        renumberTemplateItems();
      }
    };
    
    // í•­ëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function updateTemplateItemCount() {
      const count = templateItemsList.children.length;
      templateItemCount.textContent = count;
    }
    
    // ìˆœë²ˆ ì¬ì •ë ¬
    function renumberTemplateItems() {
      const items = templateItemsList.children;
      Array.from(items).forEach((item, index) => {
        const numberSpan = item.querySelector(".flex-shrink-0.w-8");
        if (numberSpan) {
          numberSpan.textContent = index + 1;
        }
      });
    }

    // í•­ëª© ëª¨ë‘ ë¹„ìš°ê¸°
    if (clearTemplateItemsBtn) {
      clearTemplateItemsBtn.addEventListener("click", () => {
        templateItemsList.innerHTML = "";
        templateItemCounter = 0;
        updateTemplateItemCount();
      });
    }

    // ë¶™ì—¬ë„£ê¸° íŒŒì„œ: í–‰ë‹¹ "ì œëª©,ë§í¬" ë˜ëŠ” íƒ­ êµ¬ë¶„
    function parsePasteText(text) {
      const rows = [];
      if (!text) return rows;
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      let order = templateItemsList.children.length;
      for (const ln of lines) {
        const parts = ln.split(/\t|,/);
        const title = (parts[0] || "").trim();
        const link = parts.length > 1 ? (parts[1] || "").trim() : "";
        if (title) {
          rows.push({ order_no: ++order, title, link_url: link || null });
        }
      }
      return rows;
    }

    // CSV í…ìŠ¤íŠ¸ íŒŒì„œ (í—¤ë”: title,link_url ì§€ì›)
    function parseCsvText(csvText) {
      const rows = [];
      if (!csvText) return rows;
      const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length === 0) return rows;
      // í—¤ë” ì¶”ì •
      const header = lines[0].split(",").map(h => h.trim().toLowerCase());
      let startIdx = 0;
      let hasHeader = false;
      const titleIdx = header.indexOf("title");
      const linkIdx = header.indexOf("link_url");
      if (titleIdx !== -1 || linkIdx !== -1) {
        hasHeader = true;
        startIdx = 1;
      }
      let order = templateItemsList.children.length;
      for (let i = startIdx; i < lines.length; i++) {
        const cols = lines[i].split(",");
        const title = (cols[titleIdx !== -1 ? titleIdx : 0] || "").trim();
        const link = linkIdx !== -1 ? (cols[linkIdx] || "").trim() : (cols[1] || "").trim();
        if (title) rows.push({ order_no: ++order, title, link_url: link || null });
      }
      return rows;
    }

    // ë¶™ì—¬ë„£ê¸° â†’ í•­ëª© ì¶”ê°€
    if (createTemplatePasteBtn) {
      createTemplatePasteBtn.addEventListener("click", () => {
        const text = createTemplatePaste.value || "";
        const rows = parsePasteText(text);
        if (rows.length === 0) { alert("ì¶”ê°€í•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        rows.forEach(r => addTemplateItem(r.title, r.link_url || ""));
        renumberTemplateItems();
      });
    }

    // CSV ì—…ë¡œë“œ â†’ í•­ëª© ì¶”ê°€
    if (createTemplateImportBtn) {
      createTemplateImportBtn.addEventListener("click", () => {
        if (!createTemplateFile.files || createTemplateFile.files.length === 0) {
          alert("CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }
        const file = createTemplateFile.files[0];
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result;
          const rows = parseCsvText(text);
          if (rows.length === 0) { alert("ì¶”ê°€í•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
          rows.forEach(r => addTemplateItem(r.title, r.link_url || ""));
          renumberTemplateItems();
          createTemplateFile.value = "";
        };
        reader.onerror = () => alert("íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        reader.readAsText(file, "utf-8");
      });
    }
    
    // í…œí”Œë¦¿ ì €ì¥ ë²„íŠ¼ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
    let isSavingTemplate = false;
    if (saveCreateTemplateBtn) {
      saveCreateTemplateBtn.addEventListener("click", async () => {
        // ì´ë¯¸ ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
        if (isSavingTemplate) {
          return;
        }
        
        const title = newTemplateTitle.value.trim();
        const subject = newTemplateSubject.value.trim();
        const description = newTemplateDescription.value.trim();
        
        if (!title) {
          alert("í…œí”Œë¦¿ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        
        // ëª¨ë“  í•­ëª© ìˆ˜ì§‘
        const items = templateItemsList.children;
        const templateItems = [];
        
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const titleInput = item.querySelector('[data-field="title"]');
          const linkInput = item.querySelector('[data-field="link"]');
          
          const itemTitle = titleInput.value.trim();
          const itemLink = linkInput.value.trim();
          
          if (itemTitle) {
            templateItems.push({
              order_no: i + 1,
              title: itemTitle,
              link_url: itemLink || null
            });
          }
        }
        
        if (templateItems.length === 0) {
          alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        
        // ì €ì¥ ì¤‘ìœ¼ë¡œ í‘œì‹œ + ë²„íŠ¼ ë¹„í™œì„±í™”
        isSavingTemplate = true;
        saveCreateTemplateBtn.disabled = true;
        const originalText = saveCreateTemplateBtn.textContent;
        saveCreateTemplateBtn.textContent = "ì €ì¥ ì¤‘...";
        
        // API í˜¸ì¶œ
        try {
          const res = await fetch("/templates/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              template_title: title,
              subject: subject || null,
              description: description || null,
              items: templateItems
            })
          });
          
          const data = await res.json();
          if (data.ok) {
            alert(`í…œí”Œë¦¿ "${title}"ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (${data.item_count}ê°œ í•­ëª©)`);
            createTemplateModal.classList.add("hidden");
          } else {
            alert(data.error || "ì €ì¥ ì‹¤íŒ¨");
          }
        } catch (err) {
          alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
        } finally {
          // ì €ì¥ ì™„ë£Œ í›„ ìƒíƒœ ë³µì›
          isSavingTemplate = false;
          saveCreateTemplateBtn.disabled = false;
          saveCreateTemplateBtn.textContent = originalText;
        }
      });
    }

    // íŒŒì¼ ì—…ë¡œë“œ
    if (uploadTemplateBtn) {
      uploadTemplateBtn.addEventListener("click", async () => {
        if (!activePlanId) { alert("í™œì„± ê³„íšì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (!templateFile.files || templateFile.files.length === 0) { alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
        const fd = new FormData();
        fd.append("file", templateFile.files[0]);
        const res = await fetch(`/plan/${activePlanId}/templates/upload`, { method: "POST", body: fd });
        const data = await res.json();
        if (data.ok) {
          const cnt = await fetchTemplateCount();
          alert(`${data.count}ê°œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì´ ${cnt}ê°œ í…œí”Œë¦¿.`);
          templateStatus.textContent = `í˜„ì¬ í…œí”Œë¦¿: ${cnt}ê°œ`;
          templateFile.value = "";
        } else {
          alert(data.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");
        }
      });
    }

    // ë¶™ì—¬ë„£ê¸° ì €ì¥
    if (savePasteBtn) {
      savePasteBtn.addEventListener("click", async () => {
        if (!activePlanId) { alert("í™œì„± ê³„íšì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const text = templatePaste.value || "";
        if (!text.trim()) { alert("ë¶™ì—¬ë„£ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const res = await fetch(`/plan/${activePlanId}/templates/upload`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paste_text: text })
        });
        const data = await res.json();
        if (data.ok) {
          const cnt = await fetchTemplateCount();
          alert(`${data.count}ê°œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì´ ${cnt}ê°œ í…œí”Œë¦¿.`);
          templateStatus.textContent = `í˜„ì¬ í…œí”Œë¦¿: ${cnt}ê°œ`;
          templatePaste.value = "";
        } else {
          alert(data.error || "ì €ì¥ ì‹¤íŒ¨");
        }
      });
    }

    // ============ ìƒˆ í•™ìŠµ ê³„íš ì„ íƒ ë° ìƒì„± ëª¨ë‹¬ =============
    const planChoiceModal = document.getElementById("planChoiceModal");
    const planModal = document.getElementById("planModal");
    const openPlanModal = document.getElementById("openPlanModal");
    const closePlanChoiceModal = document.getElementById("closePlanChoiceModal");
    const openNewPlan = document.getElementById("openNewPlan");
    const openLoadPlan = document.getElementById("openLoadPlan");
    const closePlanModal = document.getElementById("closePlanModal");
    const savePlanBtn = document.getElementById("savePlanBtn");

    // â€œ+ ìƒˆ ê³„íšâ€ í´ë¦­ ì‹œ
    openPlanModal.addEventListener("click", () => {
      planChoiceModal.classList.remove("hidden");
    });

    // â€œì„ íƒ ëª¨ë‹¬â€ ë‹«ê¸°
    closePlanChoiceModal.addEventListener("click", () => {
      planChoiceModal.classList.add("hidden");
    });

    // â€œìƒˆ ê³„íš ë§Œë“¤ê¸°â€ í´ë¦­ ì‹œ
    openNewPlan.addEventListener("click", () => {
      planChoiceModal.classList.add("hidden");
      planModal.classList.remove("hidden");
    });

    // â€œë¶ˆëŸ¬ì˜¤ê¸°â€ í´ë¦­ ì‹œ
    const loadTemplateModal = document.getElementById("loadTemplateModal");
    const closeLoadTemplateModal = document.getElementById("closeLoadTemplateModal");
    const cancelLoadTemplate = document.getElementById("cancelLoadTemplate");
    const confirmLoadTemplate = document.getElementById("confirmLoadTemplate");
    
    openLoadPlan.addEventListener("click", async () => {
      planChoiceModal.classList.add("hidden");
      loadTemplateModal.classList.remove("hidden");
      // í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ
      try {
        const res = await fetch("/templates");
        const data = await res.json();
        if (data.ok) {
          const select = document.getElementById("loadTemplatePlanSelect");
          const opts = '<option value="">-- í…œí”Œë¦¿ ì„ íƒ --</option>';
          select.innerHTML = opts + (data.templates || []).map(t => 
            `<option value="${t.template_id}">${t.template_title} (${t.subject || ''})</option>`
          ).join('');
        }
      } catch (e) {
        alert('í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      }
    });

    closeLoadTemplateModal.addEventListener("click", () => {
      loadTemplateModal.classList.add("hidden");
    });

    cancelLoadTemplate.addEventListener("click", () => {
      loadTemplateModal.classList.add("hidden");
    });

    confirmLoadTemplate.addEventListener("click", async () => {
      const sourceTemplateId = document.getElementById("loadTemplatePlanSelect").value;
      const newTitle = document.getElementById("loadTemplateTitle").value.trim();
      const newSubject = document.getElementById("loadTemplateSubject").value.trim();
      const startDate = document.getElementById("loadTemplateStart").value;
      const endDate = document.getElementById("loadTemplateEnd").value;
      const selectedWeekdays = Array.from(document.querySelectorAll('.weekday-checkbox:checked')).map(cb => cb.value);

      if (!sourceTemplateId || !newTitle || !newSubject || !startDate || !endDate) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      if (!selectedWeekdays.length) {
        alert("ìµœì†Œ í•œ ê°œì˜ ìš”ì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch("/plan/create_from_template", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            source_template_id: parseInt(sourceTemplateId),
            title: newTitle,
            subject: newSubject,
            start_date: startDate,
            end_date: endDate,
            selected_weekdays: selectedWeekdays
          })
        });

        const data = await res.json();
        if (data.ok) {
          alert(data.message + "\nìƒì„±ëœ ì¼ì¼ ê³„íš: " + data.count + "ê°œ");
          loadTemplateModal.classList.add("hidden");
          location.reload();
        } else {
          alert("ê³„íš ìƒì„± ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch (error) {
        alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
      }
    });

    // ìƒˆ ê³„íš ëª¨ë‹¬ ë‹«ê¸°
    closePlanModal.addEventListener("click", () => {
      planModal.classList.add("hidden");
    });

    // ì €ì¥ ì²˜ë¦¬
    savePlanBtn.addEventListener("click", async () => {
      const title = document.getElementById("planTitle").value.trim();
      const subject = document.getElementById("planSubject").value.trim();
      const start = document.getElementById("planStart").value;
      const end = document.getElementById("planEnd").value;
      if (!title || !subject || !start || !end) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }
      
      try {
        const res = await fetch("/plan/create", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            title: title,
            subject: subject,
            start_date: start,
            end_date: end
          })
        });
        
        const data = await res.json();
        if (data.ok) {
          alert(data.message);
          planModal.classList.add("hidden");
          location.reload();
        } else {
          alert("ê³„íš ì¶”ê°€ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch (error) {
        alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
      }
    });

    // ë…„ë„ ì„ íƒ ë³€ê²½ ì‹œ í˜ì´ì§€ ë¦¬ë¡œë“œ
    const yearSelector = document.getElementById("yearSelector");
    yearSelector.addEventListener("change", (e) => {
      const selectedYear = e.target.value;
      const params = new URLSearchParams(window.location.search);
      const currentPlanId = params.get('plan_id');
      window.location.href = currentPlanId ? `/${selectedYear}?plan_id=${currentPlanId}` : `/${selectedYear}`;
    });

    // í•™ìŠµ ê³„íš ê´€ë¦¬ ëª¨ë‹¬
    const managePlanModal = document.getElementById("managePlanModal");
    const openManagePlanModalBtn = document.getElementById("openManagePlanModal");
    const closeManagePlanModalBtn = document.getElementById("closeManagePlanModal");

    openManagePlanModalBtn?.addEventListener("click", () => {
      managePlanModal.classList.remove("hidden");
    });

    closeManagePlanModalBtn?.addEventListener("click", () => {
      managePlanModal.classList.add("hidden");
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    managePlanModal?.addEventListener("click", (e) => {
      if (e.target === managePlanModal) {
        managePlanModal.classList.add("hidden");
      }
    });

    // ëª¨ë‹¬ ë‚´ ê³„íš ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼(ì´ë²¤íŠ¸ ìœ„ì„) - ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­ë§Œ ì²˜ë¦¬
    document.addEventListener("click", async (e) => {
      if (!managePlanModal || managePlanModal.classList.contains("hidden")) return;
      if (!managePlanModal.contains(e.target)) return;
      const delBtn = e.target.closest(".delete-plan-btn-modal");
      const editBtn = e.target.closest(".edit-plan-btn-modal");

      if (delBtn) {
        const planId = delBtn.dataset.planId;
        const planCard = delBtn.closest('[data-plan-id]');
        const titleEl = planCard ? planCard.querySelector('h3') : null;
        const title = titleEl ? titleEl.textContent : 'ì„ íƒí•œ ê³„íš';

        if (!confirm(`"${title}" ê³„íšì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œí•˜ë©´ ëª¨ë“  ì¼ì¼ ê³„íšë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
          return;
        }

        try {
          const res = await fetch(`/plan/${planId}/delete`, { method: "POST", headers: {"Content-Type": "application/json"} });
          const data = await res.json();
          if (data.ok) {
            alert(data.message);
            location.reload();
          } else {
            alert("ê³„íš ì‚­ì œ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        } catch (error) {
          alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
        }
        return;
      }

      if (editBtn) {
        const planId = editBtn.dataset.planId;
        const planData = plansDataMap[planId];
        
        if (!planData) {
          alert('ê³„íš ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ìƒì„±
        const colors = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#D4BEEE', '#FFDFD3'];
        const colorPicker = document.getElementById('colorPicker');
        const currentColor = planData.color;
        
        colorPicker.innerHTML = colors.map(color => `
          <button type="button" class="w-12 h-12 rounded-lg border-4 hover:scale-110 transition-transform color-option" 
            data-color="${color}" 
            style="background-color: ${color}; border-color: ${color === currentColor ? '#000' : '#ddd'}; border-width: ${color === currentColor ? '4px' : '2px'};">
          </button>
        `).join('');

        // ì…ë ¥ í•„ë“œì— ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('editPlanTitle').value = planData.title;
        document.getElementById('editPlanSubject').value = planData.subject;
        document.getElementById('editPlanModal').dataset.planId = planId;
        document.getElementById('editPlanModal').dataset.selectedColor = currentColor;
        
        const editPlanModal = document.getElementById('editPlanModal');
        editPlanModal.classList.remove('hidden');
        return;
      }
    });

    // ëª¨ë‹¬ ë‚´ ì¼ì¼ ê³„íš í† ê¸€
    document.querySelectorAll(".toggle-daily-plan-modal").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const planId = e.target.dataset.planId;
        const section = document.querySelector(`.daily-plan-section-modal[data-plan-id="${planId}"]`);
        
        if (section.classList.contains("hidden")) {
          // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
          await loadDailyPlansModal(planId);
          
          section.classList.remove("hidden");
          e.target.textContent = `â–² ì¼ì¼ ê³„íš ìˆ¨ê¸°ê¸°`;
        } else {
          section.classList.add("hidden");
          e.target.textContent = `â–¼ ì¼ì¼ ê³„íš ë³´ê¸°`;
        }
      });
    });

    // ëª¨ë‹¬ìš© ì¼ì¼ ê³„íš ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadDailyPlansModal(planId) {
      try {
        const res = await fetch(`/plan/${planId}/daily`);
        const data = await res.json();
        
        if (data.ok && data.daily_plans && data.daily_plans.length > 0) {
          const tbody = document.querySelector(`#daily-plan-table-modal-${planId} tbody`);
          tbody.innerHTML = '';
          
          data.daily_plans.forEach(plan => {
            const newRow = document.createElement("tr");
            newRow.className = "daily-plan-row";
            newRow.innerHTML = `
              <td class="px-4 py-2">
                <input type="date" class="border rounded px-2 py-1 w-32" value="${plan.date || ''}">
              </td>
              <td class="px-4 py-2">
                <input type="number" class="border rounded px-2 py-1 w-12" value="${plan.order || ''}">
              </td>
              <td class="px-4 py-2">
                <input type="text" class="border rounded px-2 py-1 w-full" value="${plan.description || ''}" placeholder="í•™ìŠµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
              </td>
              <td class="px-4 py-2">
                <input type="text" class="border rounded px-2 py-1 w-full" value="${plan.link_url || ''}" placeholder="ë§í¬ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
              </td>
              <td class="px-4 py-2">
                <select class="border rounded px-2 py-1 w-full">
                  <option value="planned" ${plan.status === 'planned' ? 'selected' : ''}>ì˜ˆì •</option>
                  <option value="done" ${plan.status === 'done' ? 'selected' : ''}>ì™„ë£Œ</option>
                  <option value="partial" ${plan.status === 'partial' ? 'selected' : ''}>ë¶€ë¶„ì™„ë£Œ</option>
                  <option value="missed" ${plan.status === 'missed' ? 'selected' : ''}>ë¯¸ì™„ë£Œ</option>
                </select>
              </td>
              <td class="px-4 py-2 text-center">
                <button class="delete-row-btn-modal text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
              </td>
            `;
            tbody.appendChild(newRow);
          });
        }
      } catch (error) {
        console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
      }
    }

    // ëª¨ë‹¬ ë‚´ í–‰ ì¶”ê°€ ë²„íŠ¼
    document.querySelectorAll(".add-row-btn-modal").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const planId = e.target.dataset.planId;
        const tbody = document.querySelector(`#daily-plan-table-modal-${planId} tbody`);
        
        const newRow = document.createElement("tr");
        newRow.className = "daily-plan-row";
        newRow.innerHTML = `
          <td class="px-4 py-2">
            <input type="date" class="border rounded px-2 py-1 w-32" value="${new Date().toISOString().split('T')[0]}">
          </td>
          <td class="px-4 py-2">
            <input type="number" class="border rounded px-2 py-1 w-12" value="1">
          </td>
          <td class="px-4 py-2">
            <input type="text" class="border rounded px-2 py-1 w-full" placeholder="í•™ìŠµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
          </td>
          <td class="px-4 py-2">
            <select class="border rounded px-2 py-1 w-full">
              <option value="planned" selected>ì˜ˆì •</option>
              <option value="done">ì™„ë£Œ</option>
              <option value="partial">ë¶€ë¶„ì™„ë£Œ</option>
              <option value="missed">ë¯¸ì™„ë£Œ</option>
            </select>
          </td>
          <td class="px-4 py-2 text-center">
            <button class="delete-row-btn-modal text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
          </td>
        `;
        
        tbody.appendChild(newRow);
      });
    });

    // ëª¨ë‹¬ ë‚´ í–‰ ì‚­ì œ (ì´ë²¤íŠ¸ ìœ„ì„)
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("delete-row-btn-modal") || e.target.closest(".delete-row-btn-modal")) {
        const btn = e.target.classList.contains("delete-row-btn-modal") ? e.target : e.target.closest(".delete-row-btn-modal");
        if (confirm("ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          btn.closest("tr").remove();
        }
      }
    });

    // ëª¨ë‹¬ ë‚´ ì¼ì¼ ê³„íš ì €ì¥
    document.querySelectorAll(".save-daily-plan-btn-modal").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const planId = e.target.dataset.planId;
        const rows = document.querySelectorAll(`#daily-plan-table-modal-${planId} tbody tr`);
        
        const dailyPlans = [];
        rows.forEach(row => {
          const inputs = row.querySelectorAll("input");
          const select = row.querySelector("select");
          dailyPlans.push({
            date: inputs[0].value,
            order: parseInt(inputs[1].value) || 0,
            description: inputs[2].value,
            link_url: inputs[3].value || null,
            status: select ? select.value : 'planned'
          });
        });

        try {
          const res = await fetch(`/plan/${planId}/daily`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ daily_plans: dailyPlans })
          });
          
          const data = await res.json();
          if (data.ok) {
            alert("ì¼ì¼ ê³„íšì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload(); // ë‹¬ë ¥ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        } catch (error) {
          alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
        }
      });
    });

    // ëª¨ë‹¬ ë‚´ ì·¨ì†Œ ë²„íŠ¼
    document.querySelectorAll(".cancel-edit-btn-modal").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const planId = e.target.dataset.planId;
        const section = document.querySelector(`.daily-plan-section-modal[data-plan-id="${planId}"]`);
        section.classList.add("hidden");
        
        const toggleBtn = document.querySelector(`.toggle-daily-plan-modal[data-plan-id="${planId}"]`);
        toggleBtn.textContent = `â–¼ ì¼ì¼ ê³„íš ë³´ê¸°`;
      });
    });

    // ê³„íš í¸ì§‘ ëª¨ë‹¬ ì—´ê³  ë‹«ê¸°
    const editPlanModal = document.getElementById('editPlanModal');
    const closeEditPlanModalBtn = document.getElementById('closeEditPlanModal');
    
    closeEditPlanModalBtn?.addEventListener('click', () => {
      editPlanModal.classList.add('hidden');
    });

    document.getElementById('cancelEditPlan')?.addEventListener('click', () => {
      editPlanModal.classList.add('hidden');
    });

    // ìƒ‰ìƒ ì„ íƒ
    document.addEventListener('click', (e) => {
      const colorOpt = e.target.closest('.color-option');
      if (colorOpt) {
        document.querySelectorAll('.color-option').forEach(opt => {
          opt.style.borderColor = '#ddd';
          opt.style.borderWidth = '2px';
        });
        colorOpt.style.borderColor = '#000';
        colorOpt.style.borderWidth = '4px';
        editPlanModal.dataset.selectedColor = colorOpt.dataset.color;
      }
    });

    // ê³„íš ì €ì¥
    document.getElementById('saveEditPlan')?.addEventListener('click', async () => {
      const planId = editPlanModal.dataset.planId;
      const title = document.getElementById('editPlanTitle').value.trim();
      const subject = document.getElementById('editPlanSubject').value.trim();
      const color = editPlanModal.dataset.selectedColor || '';

      if (!title) {
        alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      try {
        const res = await fetch(`/plan/${planId}/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, subject })
        });
        const data = await res.json();
        if (data.ok) {
          // ìƒ‰ìƒ ì €ì¥ (localStorage)
          if (color) {
            savePlanColorToStorage(planId, color);
          }
          alert('ê³„íšì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          editPlanModal.classList.add('hidden');
          // ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹ )
          updatePlanColors();
        } else {
          alert(data.error || 'ìˆ˜ì • ì‹¤íŒ¨');
        }
      } catch (error) {
        alert('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
      }
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    editPlanModal?.addEventListener('click', (e) => {
      if (e.target === editPlanModal) {
        editPlanModal.classList.add('hidden');
      }
    });
  });
  </script>
  <script>
  // í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
  document.addEventListener('DOMContentLoaded', () => {
    const openBtn = document.getElementById('openTemplateManageModal');
    const modal = document.getElementById('templateManageModal');
    const frame = document.getElementById('templateManageFrame');
    const closeBtn = document.getElementById('closeTemplateManageModal');

    if (openBtn && modal && frame) {
      const activePlanId = {{ active_plan.plan_id if active_plan else 'null' }};
      openBtn.addEventListener('click', () => {
        const url = activePlanId ? `/templates/manage?plan_id=${activePlanId}` : '/templates/manage';
        frame.src = url;
        modal.classList.remove('hidden');
      });
    }
    if (closeBtn && modal) {
      closeBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
      });
    }
  });
  </script>
</body>
</html>
