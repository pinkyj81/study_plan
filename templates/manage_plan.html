<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í•™ìŠµ ê³„íš ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-5xl mx-auto p-8">
    <!-- í—¤ë” -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">í•™ìŠµ ê³„íš ê´€ë¦¬</h1>
      <div class="flex gap-3">
        <button id="openPlanChoiceModal" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">+ ìƒˆ ê³„íš ì¶”ê°€</button>
        <a href="/" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium">ìº˜ë¦°ë”ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
    </div>

    <p class="text-gray-600 mb-6">ì›í•˜ì‹  ìƒˆë¡œ ê³„íšì„ ìƒì„±í•œ í›„ ì œ ê³„íšì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="grid grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <div class="text-3xl font-bold text-blue-600 mb-2">{{ stats.total_plans }}</div>
        <div class="text-sm text-gray-600">ì „ì²´ ê³„íš</div>
      </div>
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <div class="text-3xl font-bold text-green-600 mb-2">{{ stats.total_assigned }}</div>
        <div class="text-sm text-gray-600">ì´ í• ë‹¹ ê³„íš</div>
      </div>
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <div class="text-3xl font-bold text-purple-600 mb-2">{{ stats.completed }}</div>
        <div class="text-sm text-gray-600">ì™„ë£Œëœ ê³„íš</div>
      </div>
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <div class="text-3xl font-bold text-orange-600 mb-2">{{ stats.completion_rate }}%</div>
        <div class="text-sm text-gray-600">ì™„ë£Œìœ¨</div>
      </div>
    </div>

    <!-- ê³„íš ëª©ë¡ -->
    <div class="space-y-4">
      {% for plan in plans %}
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-xl font-bold">{{ plan.title }}</h3>
              <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">ë³¸ë¬¸</span>
            </div>
            <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
              <div>
                <span class="mr-1">ğŸ“š ê³¼ëª©:</span>
                <span class="font-medium">{{ plan.subject }}</span>
              </div>
              <div>
                <span class="mr-1">ğŸ“… ìƒì„±ì¼:</span>
                <span>2025-10-16</span>
              </div>
              <div>
                <span class="mr-1">ğŸ“ˆ ì§„ë„:</span>
                <span>18/38</span>
              </div>
            </div>
            <button class="toggle-daily-plan text-sm text-gray-500 hover:text-gray-700" data-plan-id="{{ plan.plan_id }}">
              â–¼ ì¼ì¼ ê³„íš ë³´ê¸° ({{ plan.days|length }}ê°œ)
            </button>
          </div>
          <div class="flex gap-2">
            <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">í• ë‹¹ ê³„íš ëë‚´ê¸°</button>
            <button class="edit-plan-btn text-blue-600 hover:text-blue-800 text-xl" data-plan-id="{{ plan.plan_id }}" title="ìˆ˜ì •">âœï¸</button>
            <button class="delete-plan-btn text-red-600 hover:text-red-800 text-xl" data-plan-id="{{ plan.plan_id }}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
          </div>
        </div>

        <!-- ì¼ì¼ ê³„íš í¸ì§‘ ì„¹ì…˜ -->
        <div class="daily-plan-section hidden mt-6 border-t pt-6" data-plan-id="{{ plan.plan_id }}">
          <h4 class="font-semibold mb-4">ì¼ì¼ ê³„íš í¸ì§‘</h4>
          
          <div class="flex gap-2 mb-4">
            <button class="add-row-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">+ í–‰ ì¶”ê°€</button>
            <button class="save-daily-plan-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">ì €ì¥</button>
            <button class="cancel-edit-btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm" data-plan-id="{{ plan.plan_id }}">ì·¨ì†Œ</button>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="daily-plan-table-{{ plan.plan_id }}">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">í•™ìŠµ ë‚ ì§œ</th>
                  <th class="px-4 py-2 text-left">ìˆœì„œ</th>
                  <th class="px-4 py-2 text-left w-1/2">í•™ìŠµ ë‚´ìš© ì„¤ëª…</th>
                  <th class="px-4 py-2 text-center">ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <!-- ì˜ˆì‹œ ë°ì´í„° -->
                <tr class="daily-plan-row">
                  <td class="px-4 py-2">
                    <input type="date" class="border rounded px-2 py-1 w-full" value="2025-11-29">
                  </td>
                  <td class="px-4 py-2">
                    <input type="number" class="border rounded px-2 py-1 w-20" value="34">
                  </td>
                  <td class="px-4 py-2">
                    <input type="text" class="border rounded px-2 py-1 w-full" value="10-2 Earth's Energy Balance" placeholder="í•™ìŠµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                  </td>
                  <td class="px-4 py-2 text-center">
                    <button class="delete-row-btn text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- í•™ìŠµ ê³„íš ì¶”ê°€ ì„ íƒ ëª¨ë‹¬ -->
  <div id="planChoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[360px] shadow-lg relative text-center">
      <button id="closePlanChoiceModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-xl">âœ•</button>
      <h2 class="text-lg font-bold mb-5">í•™ìŠµ ê³„íš ì¶”ê°€</h2>
      <div class="flex flex-col gap-3">
        <button id="openNewPlan" class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium">ìƒˆ ê³„íš ë§Œë“¤ê¸°</button>
        <button id="openLoadPlan" class="bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-lg font-medium">ê¸°ì¡´ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìƒˆ í•™ìŠµ ê³„íš ë§Œë“¤ê¸° ëª¨ë‹¬ -->
  <div id="newPlanModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[460px] shadow-lg relative">
      <button id="closeNewPlanModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-xl">âœ•</button>
      <h2 class="text-lg font-bold mb-4 text-center">ìƒˆ í•™ìŠµ ê³„íš ì¶”ê°€</h2>

      <label class="block text-sm font-medium mb-1">ê³„íš ì œëª©</label>
      <input id="planTitle" type="text" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="ì˜ˆ: TOEFL ë‹¨ì–´ ì™¸ìš°ê¸°">

      <label class="block text-sm font-medium mb-1">ê³¼ëª©ëª…</label>
      <input id="planSubject" type="text" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="ì˜ˆ: ì˜ì–´">

      <div class="flex gap-4 mb-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
          <input id="planStart" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
          <input id="planEnd" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button id="cancelNewPlan" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
        <button id="savePlanBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê³„íš ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editPlanModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[460px] shadow-lg relative">
      <button id="closeEditPlanModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-xl">âœ•</button>
      <h2 class="text-lg font-bold mb-4 text-center">í•™ìŠµ ê³„íš ìˆ˜ì •</h2>

      <input type="hidden" id="editPlanId">

      <label class="block text-sm font-medium mb-1">ê³„íš ì œëª©</label>
      <input id="editPlanTitle" type="text" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="ì˜ˆ: TOEFL ë‹¨ì–´ ì™¸ìš°ê¸°">

      <label class="block text-sm font-medium mb-1">ê³¼ëª©ëª…</label>
      <input id="editPlanSubject" type="text" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="ì˜ˆ: ì˜ì–´">

      <div class="flex gap-4 mb-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
          <input id="editPlanStart" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
          <input id="editPlanEnd" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button id="cancelEditPlan" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">ì·¨ì†Œ</button>
        <button id="updatePlanBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const planChoiceModal = document.getElementById("planChoiceModal");
    const editPlanModal = document.getElementById("editPlanModal");
    const newPlanModal = document.getElementById("newPlanModal");
    const openPlanChoiceModalBtn = document.getElementById("openPlanChoiceModal");
    const closePlanChoiceModalBtn = document.getElementById("closePlanChoiceModal");
    const openNewPlanBtn = document.getElementById("openNewPlan");
    const openLoadPlanBtn = document.getElementById("openLoadPlan");
    const closeNewPlanModalBtn = document.getElementById("closeNewPlanModal");
    const closeEditPlanModalBtn = document.getElementById("closeEditPlanModal");
    const cancelNewPlanBtn = document.getElementById("cancelNewPlan");
    const cancelEditPlanBtn = document.getElementById("cancelEditPlan");
    const savePlanBtn = document.getElementById("savePlanBtn");
    const updatePlanBtn = document.getElementById("updatePlanBtn");

    // "ìƒˆ ê³„íš ì¶”ê°€" ë²„íŠ¼ í´ë¦­
    openPlanChoiceModalBtn.addEventListener("click", () => {
      planChoiceModal.classList.remove("hidden");
    });

    // ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
    closePlanChoiceModalBtn.addEventListener("click", () => {
      planChoiceModal.classList.add("hidden");
    });

    // "ìƒˆ ê³„íš ë§Œë“¤ê¸°" í´ë¦­
    openNewPlanBtn.addEventListener("click", () => {
      planChoiceModal.classList.add("hidden");
      newPlanModal.classList.remove("hidden");
    });

    // "ê¸°ì¡´ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°" í´ë¦­
    openLoadPlanBtn.addEventListener("click", () => {
      alert("ê¸°ì¡´ ê³„íš ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
      planChoiceModal.classList.add("hidden");
    });

    // ìƒˆ ê³„íš ëª¨ë‹¬ ë‹«ê¸°
    closeNewPlanModalBtn.addEventListener("click", () => {
      newPlanModal.classList.add("hidden");
    });

    cancelNewPlanBtn.addEventListener("click", () => {
      newPlanModal.classList.add("hidden");
    });

    // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    closeEditPlanModalBtn.addEventListener("click", () => {
      editPlanModal.classList.add("hidden");
    });

    cancelEditPlanBtn.addEventListener("click", () => {
      editPlanModal.classList.add("hidden");
    });

    // ì €ì¥ ì²˜ë¦¬
    savePlanBtn.addEventListener("click", async () => {
      const title = document.getElementById("planTitle").value.trim();
      const subject = document.getElementById("planSubject").value.trim();
      const start = document.getElementById("planStart").value;
      const end = document.getElementById("planEnd").value;

      if (!title || !subject || !start || !end) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      try {
        const res = await fetch("/plan/create", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            title: title,
            subject: subject,
            start_date: start,
            end_date: end
          })
        });
        
        const data = await res.json();
        if (data.ok) {
          alert(data.message);
          newPlanModal.classList.add("hidden");
          location.reload();
        } else {
          alert("ê³„íš ì¶”ê°€ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch (error) {
        alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
      }
    });

    // ê³„íš ìˆ˜ì • ë²„íŠ¼
    document.querySelectorAll(".edit-plan-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const planId = e.target.dataset.planId;
        
        // í˜„ì¬ ê³„íš ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const planCard = e.target.closest('.bg-white');
        const title = planCard.querySelector('h3').textContent;
        const subjectSpan = planCard.querySelector('.font-medium');
        const subject = subjectSpan ? subjectSpan.textContent : '';
        
        // ëª¨ë‹¬ì— í˜„ì¬ ê°’ ì±„ìš°ê¸°
        document.getElementById("editPlanId").value = planId;
        document.getElementById("editPlanTitle").value = title;
        document.getElementById("editPlanSubject").value = subject;
        
        // ëª¨ë‹¬ ì—´ê¸°
        editPlanModal.classList.remove("hidden");
      });
    });

    // ê³„íš ìˆ˜ì • ì €ì¥
    updatePlanBtn.addEventListener("click", async () => {
      const planId = document.getElementById("editPlanId").value;
      const title = document.getElementById("editPlanTitle").value.trim();
      const subject = document.getElementById("editPlanSubject").value.trim();
      const start = document.getElementById("editPlanStart").value;
      const end = document.getElementById("editPlanEnd").value;

      if (!title || !subject) {
        alert("ì œëª©ê³¼ ê³¼ëª©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤!");
        return;
      }

      try {
        const res = await fetch(`/plan/${planId}/update`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            title: title,
            subject: subject,
            start_date: start,
            end_date: end
          })
        });
        
        const data = await res.json();
        if (data.ok) {
          alert(data.message);
          editPlanModal.classList.add("hidden");
          location.reload();
        } else {
          alert("ê³„íš ìˆ˜ì • ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch (error) {
        alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
      }
    });

    // ê³„íš ì‚­ì œ ë²„íŠ¼
    document.querySelectorAll(".delete-plan-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const planId = e.target.dataset.planId;
        const planCard = e.target.closest('.bg-white');
        const title = planCard.querySelector('h3').textContent;
        
        if (!confirm(`"${title}" ê³„íšì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œí•˜ë©´ ëª¨ë“  ì¼ì¼ ê³„íšë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
          return;
        }

        try {
          const res = await fetch(`/plan/${planId}/delete`, {
            method: "POST",
            headers: {"Content-Type": "application/json"}
          });
          
          const data = await res.json();
          if (data.ok) {
            alert(data.message);
            location.reload();
          } else {
            alert("ê³„íš ì‚­ì œ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        } catch (error) {
          alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
        }
      });
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    planChoiceModal.addEventListener("click", (e) => {
      if (e.target === planChoiceModal) {
        planChoiceModal.classList.add("hidden");
      }
    });

    newPlanModal.addEventListener("click", (e) => {
      if (e.target === newPlanModal) {
        newPlanModal.classList.add("hidden");
      }
    });

    editPlanModal.addEventListener("click", (e) => {
      if (e.target === editPlanModal) {
        editPlanModal.classList.add("hidden");
      }
    });

    // ì¼ì¼ ê³„íš í¸ì§‘ í† ê¸€
    document.querySelectorAll(".toggle-daily-plan").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const planId = e.target.dataset.planId;
        const section = document.querySelector(`.daily-plan-section[data-plan-id="${planId}"]`);
        
        if (section.classList.contains("hidden")) {
          // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
          await loadDailyPlans(planId);
          
          section.classList.remove("hidden");
          e.target.textContent = `â–² ì¼ì¼ ê³„íš ìˆ¨ê¸°ê¸°`;
        } else {
          section.classList.add("hidden");
          e.target.textContent = `â–¼ ì¼ì¼ ê³„íš ë³´ê¸°`;
        }
      });
    });

    // ì¼ì¼ ê³„íš ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadDailyPlans(planId) {
      try {
        const res = await fetch(`/plan/${planId}/daily`);
        const data = await res.json();
        
        if (data.ok && data.daily_plans && data.daily_plans.length > 0) {
          const tbody = document.querySelector(`#daily-plan-table-${planId} tbody`);
          tbody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì œê±°
          
          data.daily_plans.forEach(plan => {
            const newRow = document.createElement("tr");
            newRow.className = "daily-plan-row";
            newRow.innerHTML = `
              <td class="px-4 py-2">
                <input type="date" class="border rounded px-2 py-1 w-full" value="${plan.date || ''}">
              </td>
              <td class="px-4 py-2">
                <input type="number" class="border rounded px-2 py-1 w-20" value="${plan.order || ''}">
              </td>
              <td class="px-4 py-2">
                <input type="text" class="border rounded px-2 py-1 w-full" value="${plan.description || ''}" placeholder="í•™ìŠµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
              </td>
              <td class="px-4 py-2 text-center">
                <button class="delete-row-btn text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
              </td>
            `;
            tbody.appendChild(newRow);
          });
        }
      } catch (error) {
        console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
      }
    }

    // í–‰ ì¶”ê°€ ë²„íŠ¼
    document.querySelectorAll(".add-row-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const planId = e.target.dataset.planId;
        const tbody = document.querySelector(`#daily-plan-table-${planId} tbody`);
        
        const newRow = document.createElement("tr");
        newRow.className = "daily-plan-row";
        newRow.innerHTML = `
          <td class="px-4 py-2">
            <input type="date" class="border rounded px-2 py-1 w-full" value="${new Date().toISOString().split('T')[0]}">
          </td>
          <td class="px-4 py-2">
            <input type="number" class="border rounded px-2 py-1 w-20" value="1">
          </td>
          <td class="px-4 py-2">
            <input type="text" class="border rounded px-2 py-1 w-full" placeholder="í•™ìŠµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
          </td>
          <td class="px-4 py-2 text-center">
            <button class="delete-row-btn text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
          </td>
        `;
        
        tbody.appendChild(newRow);
        
        // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì˜ ì‚­ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì¶”ê°€
        newRow.querySelector(".delete-row-btn").addEventListener("click", function() {
          if (confirm("ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            newRow.remove();
          }
        });
      });
    });

    // í–‰ ì‚­ì œ ë²„íŠ¼
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("delete-row-btn") || e.target.closest(".delete-row-btn")) {
        const btn = e.target.classList.contains("delete-row-btn") ? e.target : e.target.closest(".delete-row-btn");
        if (confirm("ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          btn.closest("tr").remove();
        }
      }
    });

    // ì¼ì¼ ê³„íš ì €ì¥
    document.querySelectorAll(".save-daily-plan-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const planId = e.target.dataset.planId;
        const rows = document.querySelectorAll(`#daily-plan-table-${planId} tbody tr`);
        
        const dailyPlans = [];
        rows.forEach(row => {
          const inputs = row.querySelectorAll("input");
          dailyPlans.push({
            date: inputs[0].value,
            order: parseInt(inputs[1].value) || 0,
            description: inputs[2].value
          });
        });

        try {
          const res = await fetch(`/plan/${planId}/daily`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ daily_plans: dailyPlans })
          });
          
          const data = await res.json();
          if (data.ok) {
            alert("ì¼ì¼ ê³„íšì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        } catch (error) {
          alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
        }
      });
    });

    // ì·¨ì†Œ ë²„íŠ¼
    document.querySelectorAll(".cancel-edit-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const planId = e.target.dataset.planId;
        const section = document.querySelector(`.daily-plan-section[data-plan-id="${planId}"]`);
        section.classList.add("hidden");
        
        const toggleBtn = document.querySelector(`.toggle-daily-plan[data-plan-id="${planId}"]`);
        toggleBtn.textContent = `â–¼ ì¼ì¼ ê³„íš ë³´ê¸°`;
      });
    });
  });
  </script>
</body>
</html>

